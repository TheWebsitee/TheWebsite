<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Page</title>
</head>
<body>
    <h1>Global Page Visit Counter</h1>
    <p>This page has been visited <span id="visit-count">...</span> times.</p>

    <script type="module">
        // Import the functions you need from the SDKs you need
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.2/firebase-app.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/10.13.2/firebase-analytics.js";
        import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/10.13.2/firebase-firestore.js";

        // Your web app's Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyCPQ-VEkUIU7a4OOpK8yeS2GhAmR8wiK1M",
            authDomain: "thewebsite-d7a18.firebaseapp.com",
            projectId: "thewebsite-d7a18",
            storageBucket: "thewebsite-d7a18.appspot.com",
            messagingSenderId: "157727332699",
            appId: "1:157727332699:web:44008cbc8428196c7c627e",
            measurementId: "G-1TCEBXE7RB"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const analytics = getAnalytics(app);
        const db = getFirestore(app);

        // Function to set a cookie
        function setCookie(name, value) {
            const expires = "expires=Fri, 31 Dec 9999 23:59:59 GMT";
            document.cookie = name + "=" + value + ";" + expires + ";path=/";
        }

        // Function to get a cookie by name
        function getCookie(name) {
            const cname = name + "=";
            const decodedCookie = decodeURIComponent(document.cookie);
            const cookieArr = decodedCookie.split(';');
            for (let i = 0; i < cookieArr.length; i++) {
                let c = cookieArr[i].trim();
                if (c.indexOf(cname) === 0) {
                    return c.substring(cname.length, c.length);
                }
            }
            return "";
        }

        // Function to update and fetch the visit count
        async function updateVisitCount() {
            // Check if the user has a 'visited' cookie
            const visited = getCookie("visited");

            if (!visited) {
                // If the cookie is not found, increment the counter and set the cookie
                const visitRef = doc(db, 'counters', 'pageVisits'); // Reference to the document in Firestore

                try {
                    const docSnap = await getDoc(visitRef);

                    if (docSnap.exists()) {
                        let visitCount = docSnap.data().count;
                        console.log("Current visit count:", visitCount); // Debugging

                        // Increment the count
                        visitCount++;
                        document.getElementById('visit-count').textContent = visitCount;

                        // Update the count in Firestore
                        await setDoc(visitRef, { count: visitCount });
                        console.log("Visit count updated successfully");
                    } else {
                        // If the document doesn't exist, create it with an initial count of 1
                        console.log("No document found, creating new document...");
                        await setDoc(visitRef, { count: 1 });
                        document.getElementById('visit-count').textContent = 1;
                    }

                    // Set the 'visited' cookie to prevent future increments for this user
                    setCookie("visited", "true", 7); // Cookie expires in 7 days
                } catch (error) {
                    console.error("Error getting or updating document:", error);
                }
            } else {
                console.log("User has already visited the page, not incrementing counter.");
            }
        }

        // Call the function when the page loads
        updateVisitCount();
    </script>
    <script>
        async function updateVisitCount() {
    // Check if the user has a 'visited' cookie
    const visited = getCookie("visited");

    const visitRef = doc(db, 'counters', 'pageVisits'); // Reference to the document in Firestore
    try {
        const docSnap = await getDoc(visitRef);

        if (!visited) {
            // If the cookie is not found, increment the counter
            if (docSnap.exists()) {
                let visitCount = docSnap.data().count;
                console.log("Current visit count before incrementing:", visitCount); // Debugging

                // Increment the count
                visitCount++;
                document.getElementById('visit-count').textContent = visitCount;

                // Update the count in Firestore
                await setDoc(visitRef, { count: visitCount });
                console.log("Visit count updated successfully to:", visitCount);
            } else {
                // If the document doesn't exist, create it with an initial count of 1
                console.log("No document found, creating new document...");
                await setDoc(visitRef, { count: 1 });
                document.getElementById('visit-count').textContent = 1;
            }

            // Set the 'visited' cookie to prevent future increments for this user
            setCookie("visited", "true");
        } else {
            // If the cookie is found, display the current count
            if (docSnap.exists()) {
                const visitCount = docSnap.data().count;
                document.getElementById('visit-count').textContent = visitCount;
                console.log("User has already visited the page. Visit count:", visitCount);
            }
        }
    } catch (error) {
        console.error("Error getting or updating document:", error);
    }
}

    </script>
</body>
</html>
